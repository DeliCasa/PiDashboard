# Pi Dashboard Nightly Test Workflow (T082-T083)
#
# Full test suite with multi-browser matrix and E2E sharding.
# Runs nightly at 3 AM UTC and on manual trigger.
# Tests all browsers: chromium, firefox (webkit skipped on Linux)

name: Nightly Tests

on:
  schedule:
    - cron: '0 3 * * *' # 3 AM UTC daily
  workflow_dispatch: # Allow manual trigger
    inputs:
      browser:
        description: 'Browser to test (all for full matrix)'
        required: false
        default: 'all'
        type: choice
        options:
          - all
          - chromium
          - firefox

# Cancel in-progress runs for the same workflow
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # Unit and Integration Tests
  unit-tests:
    name: Unit & Integration Tests
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run all tests
        run: npm test

      - name: Run tests with coverage
        run: npm run test:coverage

      - name: Upload coverage report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: coverage-report-nightly
          path: coverage/
          retention-days: 30

  # Full E2E Tests with Sharding (T083)
  e2e-chromium:
    name: E2E Tests (Chromium - shard ${{ matrix.shard }}/2)
    runs-on: ubuntu-latest
    timeout-minutes: 30
    needs: unit-tests

    strategy:
      fail-fast: false
      matrix:
        shard: [1, 2]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Nix
        uses: cachix/install-nix-action@v31
        with:
          nix_path: nixpkgs=channel:nixos-unstable

      - name: Setup Magic Nix Cache
        uses: DeterminateSystems/magic-nix-cache-action@main

      - name: Setup Cachix
        uses: cachix/cachix-action@v15
        with:
          name: nix-community

      - name: Install dependencies in Nix shell
        run: nix develop --command npm ci

      - name: Build application
        run: nix develop --command npm run build

      - name: Run E2E tests (sharded)
        run: |
          nix develop --command npx playwright test \
            --project=chromium \
            --shard=${{ matrix.shard }}/2

      - name: Upload Playwright report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: playwright-report-chromium-shard-${{ matrix.shard }}
          path: playwright-report/
          retention-days: 30

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results-chromium-shard-${{ matrix.shard }}
          path: test-results/
          retention-days: 30

      - name: Upload Playwright traces on failure
        uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: playwright-traces-chromium-shard-${{ matrix.shard }}
          path: |
            test-results/**/*.zip
            test-results/**/*.png
            test-results/**/*.webm
          retention-days: 30

  # Firefox E2E Tests with Sharding
  e2e-firefox:
    name: E2E Tests (Firefox - shard ${{ matrix.shard }}/2)
    runs-on: ubuntu-latest
    timeout-minutes: 30
    needs: unit-tests

    strategy:
      fail-fast: false
      matrix:
        shard: [1, 2]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Nix
        uses: cachix/install-nix-action@v31
        with:
          nix_path: nixpkgs=channel:nixos-unstable

      - name: Setup Magic Nix Cache
        uses: DeterminateSystems/magic-nix-cache-action@main

      - name: Setup Cachix
        uses: cachix/cachix-action@v15
        with:
          name: nix-community

      - name: Install dependencies in Nix shell
        run: nix develop --command npm ci

      - name: Build application
        run: nix develop --command npm run build

      - name: Run E2E tests (sharded)
        run: |
          nix develop --command npx playwright test \
            --project=firefox \
            --shard=${{ matrix.shard }}/2

      - name: Upload Playwright report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: playwright-report-firefox-shard-${{ matrix.shard }}
          path: playwright-report/
          retention-days: 30

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results-firefox-shard-${{ matrix.shard }}
          path: test-results/
          retention-days: 30

      - name: Upload Playwright traces on failure
        uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: playwright-traces-firefox-shard-${{ matrix.shard }}
          path: |
            test-results/**/*.zip
            test-results/**/*.png
            test-results/**/*.webm
          retention-days: 30

  # Accessibility Tests (full scan)
  accessibility:
    name: Accessibility Scan
    runs-on: ubuntu-latest
    timeout-minutes: 20
    needs: unit-tests

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Nix
        uses: cachix/install-nix-action@v31
        with:
          nix_path: nixpkgs=channel:nixos-unstable

      - name: Setup Magic Nix Cache
        uses: DeterminateSystems/magic-nix-cache-action@main

      - name: Setup Cachix
        uses: cachix/cachix-action@v15
        with:
          name: nix-community

      - name: Install dependencies in Nix shell
        run: nix develop --command npm ci

      - name: Build application
        run: nix develop --command npm run build

      - name: Run accessibility tests
        run: nix develop --command npx playwright test tests/e2e/accessibility.spec.ts --project=chromium

      - name: Upload accessibility report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: accessibility-report
          path: playwright-report/
          retention-days: 30

  # Resilience/Network Failure Tests
  resilience:
    name: Resilience Tests
    runs-on: ubuntu-latest
    timeout-minutes: 20
    needs: unit-tests

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Nix
        uses: cachix/install-nix-action@v31
        with:
          nix_path: nixpkgs=channel:nixos-unstable

      - name: Setup Magic Nix Cache
        uses: DeterminateSystems/magic-nix-cache-action@main

      - name: Setup Cachix
        uses: cachix/cachix-action@v15
        with:
          name: nix-community

      - name: Install dependencies in Nix shell
        run: nix develop --command npm ci

      - name: Build application
        run: nix develop --command npm run build

      - name: Run resilience tests
        # Feature 037: Include new API resilience tests in nightly run
        run: nix develop --command npx playwright test tests/e2e/resilience.spec.ts tests/e2e/cameras-resilience.spec.ts tests/e2e/wifi-degradation.spec.ts tests/e2e/door-resilience.spec.ts tests/e2e/system-resilience.spec.ts --project=chromium

      - name: Upload resilience report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: resilience-report
          path: playwright-report/
          retention-days: 30

  # Merge shard reports
  merge-reports:
    name: Merge E2E Reports
    runs-on: ubuntu-latest
    needs: [e2e-chromium, e2e-firefox]
    if: always()

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Download all shard reports
        uses: actions/download-artifact@v4
        with:
          path: all-reports
          pattern: playwright-report-*

      - name: Merge reports
        run: |
          npx playwright merge-reports --reporter html ./all-reports/* || echo "Report merge skipped"

      - name: Upload merged report
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report-merged
          path: playwright-report/
          retention-days: 30

  # Summary job
  nightly-summary:
    name: Nightly Summary
    runs-on: ubuntu-latest
    needs: [unit-tests, e2e-chromium, e2e-firefox, accessibility, resilience]
    if: always()

    steps:
      - name: Check nightly results
        env:
          UNIT_RESULT: ${{ needs.unit-tests.result }}
          CHROMIUM_RESULT: ${{ needs.e2e-chromium.result }}
          FIREFOX_RESULT: ${{ needs.e2e-firefox.result }}
          A11Y_RESULT: ${{ needs.accessibility.result }}
          RESILIENCE_RESULT: ${{ needs.resilience.result }}
        run: |
          echo "üìä Nightly Test Results"
          echo "======================"
          echo ""

          FAILED=0

          if [[ "$UNIT_RESULT" == "success" ]]; then
            echo "‚úÖ Unit & Integration Tests: PASSED"
          else
            echo "‚ùå Unit & Integration Tests: $UNIT_RESULT"
            FAILED=1
          fi

          if [[ "$CHROMIUM_RESULT" == "success" ]]; then
            echo "‚úÖ E2E Tests (Chromium): PASSED"
          else
            echo "‚ùå E2E Tests (Chromium): $CHROMIUM_RESULT"
            FAILED=1
          fi

          if [[ "$FIREFOX_RESULT" == "success" ]]; then
            echo "‚úÖ E2E Tests (Firefox): PASSED"
          else
            echo "‚ùå E2E Tests (Firefox): $FIREFOX_RESULT"
            FAILED=1
          fi

          if [[ "$A11Y_RESULT" == "success" ]]; then
            echo "‚úÖ Accessibility Tests: PASSED"
          else
            echo "‚ö†Ô∏è Accessibility Tests: $A11Y_RESULT"
          fi

          if [[ "$RESILIENCE_RESULT" == "success" ]]; then
            echo "‚úÖ Resilience Tests: PASSED"
          else
            echo "‚ö†Ô∏è Resilience Tests: $RESILIENCE_RESULT"
          fi

          echo ""
          if [[ "$FAILED" -eq 1 ]]; then
            echo "‚ùå Nightly tests had failures"
            exit 1
          fi
          echo "‚úÖ All critical nightly tests passed!"
