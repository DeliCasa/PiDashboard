# Handoff Sentinel CI Check
# Ensures all incoming handoffs are acknowledged before merge
#
# This workflow can be:
# 1. Added to required checks to block merges with unacknowledged handoffs
# 2. Run as a standalone check on PRs
# 3. Scheduled to run periodically

name: Handoff Check

on:
  pull_request:
    branches: [main]
    paths:
      - 'docs/HANDOFF_*.md'
      - 'docs/handoffs/**/*.md'
      - 'specs/**/HANDOFF*.md'
      - 'specs/**/handoff*.md'
  workflow_dispatch:
    inputs:
      strict:
        description: 'Fail if pending handoffs exist'
        required: false
        default: 'true'
        type: boolean

jobs:
  check-handoffs:
    name: Check Handoffs
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run handoff detection
        id: detect
        env:
          EVENT_NAME: ${{ github.event_name }}
          INPUT_STRICT: ${{ inputs.strict }}
        run: |
          # Determine if strict mode should be used
          STRICT_FLAG=""
          if [[ "$EVENT_NAME" == "workflow_dispatch" ]]; then
            if [[ "$INPUT_STRICT" == "true" ]]; then
              STRICT_FLAG="--strict"
            fi
          else
            # Default to strict on PRs
            STRICT_FLAG="--strict"
          fi

          # Run detection and capture output to file
          npm run handoff:detect -- --json $STRICT_FLAG > handoff-output.json 2>&1 || true

          # Parse results
          if jq -e '.pending | length > 0' handoff-output.json > /dev/null 2>&1; then
            echo "has_pending=true" >> "$GITHUB_OUTPUT"
          else
            echo "has_pending=false" >> "$GITHUB_OUTPUT"
          fi

          # Store counts for summary
          PENDING_COUNT=$(jq -r '.pending | length' handoff-output.json 2>/dev/null || echo "0")
          ERROR_COUNT=$(jq -r '.errors | length' handoff-output.json 2>/dev/null || echo "0")
          echo "pending_count=$PENDING_COUNT" >> "$GITHUB_OUTPUT"
          echo "error_count=$ERROR_COUNT" >> "$GITHUB_OUTPUT"

      - name: Report results
        if: always()
        env:
          PENDING_COUNT: ${{ steps.detect.outputs.pending_count }}
          ERROR_COUNT: ${{ steps.detect.outputs.error_count }}
        run: |
          echo "### Handoff Check Results" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"

          if [[ "$PENDING_COUNT" == "0" ]] && [[ "$ERROR_COUNT" == "0" ]]; then
            echo "✅ No pending handoffs found" >> "$GITHUB_STEP_SUMMARY"
          else
            if [[ "$PENDING_COUNT" != "0" ]]; then
              echo "⚠️ **$PENDING_COUNT pending handoff(s)** require attention" >> "$GITHUB_STEP_SUMMARY"
              echo "" >> "$GITHUB_STEP_SUMMARY"
              echo "Edit the handoff frontmatter to acknowledge:" >> "$GITHUB_STEP_SUMMARY"
              echo '```yaml' >> "$GITHUB_STEP_SUMMARY"
              echo 'status: acknowledged  # or in_progress, done' >> "$GITHUB_STEP_SUMMARY"
              echo '```' >> "$GITHUB_STEP_SUMMARY"
            fi

            if [[ "$ERROR_COUNT" != "0" ]]; then
              echo "" >> "$GITHUB_STEP_SUMMARY"
              echo "❌ **$ERROR_COUNT validation error(s)** found" >> "$GITHUB_STEP_SUMMARY"
            fi
          fi

      - name: Fail on pending (strict mode)
        env:
          HAS_PENDING: ${{ steps.detect.outputs.has_pending }}
        if: env.HAS_PENDING == 'true'
        run: |
          echo "::error::Pending handoffs require acknowledgment before merge"
          exit 1
