# Implementation Plan: Delta Correction Flow

**Branch**: `053-delta-correction-flow` | **Date**: 2026-02-16 | **Spec**: [spec.md](spec.md)
**Input**: Feature specification from `/specs/053-delta-correction-flow/spec.md`

## Summary

Close test coverage gaps in the inventory delta correction workflow. The UI components are already implemented across Features 047-052; this feature adds missing component tests (add/remove items, validation, confirmation dialog, conflict handling), hardens contract tests for review error variants, writes a full E2E correction workflow test, and produces a HANDOFF document with a manual verification walkthrough.

## Technical Context

**Language/Version**: TypeScript ~5.9.3
**Primary Dependencies**: React 19.2.0, TanStack React Query 5.x, Zod 3.x, shadcn/ui (Radix UI), Tailwind CSS v4, lucide-react, sonner
**Storage**: N/A (API-driven; active container via localStorage/Zustand from Feature 046)
**Testing**: Vitest 3.2.4 (unit/component/contract), Playwright 1.57.0 (E2E), MSW 2.x (API mocking in Vitest), Playwright route interception (E2E mocking)
**Target Platform**: Chromium-based browsers (primary), Firefox (nightly)
**Project Type**: Web (single SPA)
**Performance Goals**: E2E correction workflow completes in < 60s; all tests pass in CI
**Constraints**: VITEST_MAX_WORKERS=1 for CI; PLAYWRIGHT_WORKERS=1 for reproducibility
**Scale/Scope**: ~15-20 new tests (component), ~5-8 new contract tests, ~8-12 new E2E tests

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

### I. Hexagonal Architecture — PASS

No production code changes expected. All new code is test files, which are outside the architecture layers. If FR-015 (low-confidence banner) requires implementation, it will be in the presentation layer consuming application hooks — compliant.

### II. Contract-First API — PASS

This feature strengthens contract testing by adding explicit tests for review error variants (409, 400, 503) and correction validation edge cases. All mock fixtures already pass Zod schema validation.

### III. Test Discipline — PASS

This feature IS the test discipline work. All new tests follow established patterns:
- Component tests: RTL + Vitest + MSW
- Contract tests: Zod `.safeParse()` assertions
- E2E tests: Playwright route interception via `mockEndpoint()`
- Resource constraints: Single-worker execution

### IV. Simplicity & YAGNI — PASS

No new abstractions, utilities, or production code beyond what's needed. Tests are the deliverable.

### Post-Design Re-check — PASS

All Phase 1 artifacts (data-model.md, contracts/, quickstart.md) confirm no architecture violations. The data model documents existing entities; no new entities are introduced.

## Project Structure

### Documentation (this feature)

```text
specs/053-delta-correction-flow/
├── spec.md              # Feature specification
├── plan.md              # This file
├── research.md          # Gap analysis and decisions
├── data-model.md        # Existing entity documentation
├── quickstart.md        # Developer quickstart guide
├── contracts/
│   └── api-contracts.md # API contract test expectations
├── checklists/
│   └── requirements.md  # Spec quality checklist
└── tasks.md             # Generated by /speckit.tasks
```

### Source Code (repository root)

```text
tests/
├── component/inventory/
│   ├── InventoryReviewForm.test.tsx    # EXTEND: add/remove, validation, dialog, conflict
│   ├── InventoryDeltaTable.test.tsx    # EXTEND: low-confidence banner, zero-delta
│   └── InventoryRunDetail.test.tsx     # EXTEND: low-confidence, zero-delta integration
├── integration/contracts/
│   └── inventory-delta.contract.test.ts # EXTEND: review error variants, correction validation
├── e2e/
│   ├── inventory-correction-flow.spec.ts # NEW: full correction workflow E2E
│   └── fixtures/
│       └── mock-routes.ts              # EXTEND: review submit helpers
├── mocks/
│   └── inventory-delta-fixtures.ts     # EXTEND: post-correction run fixture (if needed)

specs/053-delta-correction-flow/
└── HANDOFF_053.md                      # NEW: manual verification walkthrough
```

**Structure Decision**: Test-only feature — all changes are in `tests/` and `specs/`. Production code changes only if FR-015 (low-confidence banner) needs implementation in `src/presentation/components/inventory/InventoryDeltaTable.tsx`.

## Design Decisions

### D1: Component Test Extensions vs. New Files

**Decision**: Extend existing test files rather than creating new ones.

**Rationale**: The gaps (add/remove items, validation, dialog, conflict) are all in `InventoryReviewForm.test.tsx`. Adding new `describe()` blocks to existing files follows the project convention and avoids file fragmentation.

### D2: E2E Test: Single File vs. Split

**Decision**: Create one new E2E file `inventory-correction-flow.spec.ts` with multiple `test.describe()` blocks.

**Rationale**: The correction flow is a single coherent workflow. Splitting across files would make it harder to understand the full flow. Other inventory E2E tests (`inventory-delta.spec.ts`, `inventory-delta-golden.spec.ts`) cover viewing scenarios; the new file focuses exclusively on the correction/review workflow.

### D3: Mock Helpers in E2E

**Decision**: Add `mockReviewSubmit()` and `mockReviewConflict()` helpers to `mock-routes.ts`.

**Rationale**: Multiple E2E tests will need to mock the POST review endpoint. Following the existing pattern of `mockCamerasSuccess()`, `mockCamerasError()`, etc., shared helpers avoid duplication.

### D4: FR-015 Low-Confidence Banner

**Decision**: Verify if already implemented; add tests regardless. Implement if missing.

**Rationale**: Research indicates `data-testid="low-confidence-banner"` exists in InventoryDeltaTable, suggesting it's implemented. If not, the implementation is ~10 lines (conditional banner based on avg confidence). Tests are needed either way.

## Work Breakdown

### Phase 1: Component Test Hardening

1. **InventoryReviewForm tests** — add/remove items, form validation, confirmation dialog, conflict handling
2. **InventoryDeltaTable tests** — low-confidence banner, zero-delta empty state
3. **InventoryRunDetail tests** — low-confidence integration, zero-delta integration

### Phase 2: Contract Test Hardening

4. **Review error variant tests** — 409/400 envelope validation
5. **Correction validation tests** — empty name, negative count, flag conflicts

### Phase 3: E2E Mock Helpers

6. **mock-routes.ts extensions** — review submit/conflict helpers
7. **Post-correction fixture** — run state after review submission

### Phase 4: E2E Correction Workflow

8. **Full correction flow** — view → edit → submit → verify audit trail
9. **Approve as-is flow** — approve without corrections
10. **Conflict handling** — 409 → conflict UI → refresh
11. **Edge cases** — zero-delta, low-confidence, 503

### Phase 5: HANDOFF & Verification

12. **HANDOFF_053.md** — manual verification walkthrough
13. **Final test run** — all tests pass, lint clean, build succeeds
