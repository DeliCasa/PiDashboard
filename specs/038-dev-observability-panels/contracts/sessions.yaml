openapi: 3.0.3
info:
  title: DEV Diagnostics - Sessions & Evidence API
  description: |
    Session and evidence endpoints for DEV observability panels.
    Consumed from BridgeServer.
  version: 1.0.0

paths:
  /api/v1/sessions:
    get:
      operationId: listSessions
      summary: List active sessions
      description: |
        Returns list of active purchase/evidence sessions.
        Used for DEV diagnostics session monitoring.
      tags:
        - Sessions
      parameters:
        - name: status
          in: query
          schema:
            type: string
            enum: [active, completed, cancelled, all]
            default: active
          description: Filter by session status
        - name: limit
          in: query
          schema:
            type: integer
            minimum: 1
            maximum: 100
            default: 50
          description: Maximum number of sessions to return
      responses:
        '200':
          description: Sessions retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SessionListResponse'
              example:
                success: true
                data:
                  sessions:
                    - id: sess-12345
                      delivery_id: del-67890
                      started_at: '2026-01-25T14:00:00Z'
                      status: active
                      capture_count: 5
                      last_capture_at: '2026-01-25T14:45:00Z'
        '500':
          description: Server error

  /api/v1/sessions/{sessionId}:
    get:
      operationId: getSession
      summary: Get session details
      description: Returns session details with evidence list.
      tags:
        - Sessions
      parameters:
        - name: sessionId
          in: path
          required: true
          schema:
            type: string
          description: Session ID
      responses:
        '200':
          description: Session retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SessionDetailResponse'
        '404':
          description: Session not found

  /api/v1/sessions/{sessionId}/evidence:
    get:
      operationId: listSessionEvidence
      summary: List session evidence captures
      description: |
        Returns evidence captures for a session with presigned thumbnail URLs.
        URLs expire after 15 minutes by default.
      tags:
        - Evidence
      parameters:
        - name: sessionId
          in: path
          required: true
          schema:
            type: string
          description: Session ID
        - name: limit
          in: query
          schema:
            type: integer
            minimum: 1
            maximum: 100
            default: 50
          description: Maximum number of captures to return
      responses:
        '200':
          description: Evidence retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/EvidenceListResponse'
              example:
                success: true
                data:
                  evidence:
                    - id: img-550e8400-e29b-41d4-a716-446655440000
                      session_id: sess-12345
                      captured_at: '2026-01-25T14:30:00Z'
                      camera_id: espcam-b0f7f1
                      thumbnail_url: 'https://minio.../thumb.jpg?X-Amz-...'
                      full_url: 'https://minio.../full.jpg?X-Amz-...'
                      expires_at: '2026-01-25T14:45:00Z'
                      size_bytes: 45678
                      content_type: image/jpeg
        '404':
          description: Session not found

  /api/v1/images/presign:
    get:
      operationId: getPresignedUrl
      summary: Generate presigned URL for image
      description: |
        Generates a fresh presigned URL for accessing an image.
        Used to refresh expired URLs for evidence viewing.
      tags:
        - Evidence
      parameters:
        - name: key
          in: query
          required: true
          schema:
            type: string
          description: Object key (path in storage)
        - name: expiresIn
          in: query
          schema:
            type: integer
            minimum: 60
            maximum: 3600
            default: 900
          description: URL expiration time in seconds
      responses:
        '200':
          description: Presigned URL generated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PresignResponse'
              example:
                success: true
                data:
                  url: 'https://minio.../image.jpg?X-Amz-Algorithm=...'
                  expires_at: '2026-01-25T15:00:00Z'
        '400':
          description: Invalid key parameter
        '404':
          description: Image not found

components:
  schemas:
    SessionListResponse:
      type: object
      required:
        - success
        - data
      properties:
        success:
          type: boolean
        data:
          type: object
          required:
            - sessions
          properties:
            sessions:
              type: array
              items:
                $ref: '#/components/schemas/Session'

    SessionDetailResponse:
      type: object
      required:
        - success
        - data
      properties:
        success:
          type: boolean
        data:
          $ref: '#/components/schemas/SessionWithEvidence'

    Session:
      type: object
      required:
        - id
        - started_at
        - status
        - capture_count
      properties:
        id:
          type: string
          description: Unique session identifier
        delivery_id:
          type: string
          description: Associated delivery ID
        started_at:
          type: string
          format: date-time
          description: Session start timestamp
        status:
          type: string
          enum: [active, completed, cancelled]
          description: Current session state
        capture_count:
          type: integer
          minimum: 0
          description: Number of evidence captures
        last_capture_at:
          type: string
          format: date-time
          description: Last capture timestamp

    SessionWithEvidence:
      allOf:
        - $ref: '#/components/schemas/Session'
        - type: object
          properties:
            evidence:
              type: array
              items:
                $ref: '#/components/schemas/EvidenceCapture'

    EvidenceListResponse:
      type: object
      required:
        - success
        - data
      properties:
        success:
          type: boolean
        data:
          type: object
          required:
            - evidence
          properties:
            evidence:
              type: array
              items:
                $ref: '#/components/schemas/EvidenceCapture'

    EvidenceCapture:
      type: object
      required:
        - id
        - session_id
        - captured_at
        - camera_id
        - thumbnail_url
        - full_url
        - expires_at
      properties:
        id:
          type: string
          description: Unique capture identifier
        session_id:
          type: string
          description: Parent session ID
        captured_at:
          type: string
          format: date-time
          description: Capture timestamp
        camera_id:
          type: string
          pattern: '^espcam-[0-9a-f]{6}$'
          description: Camera identifier
        thumbnail_url:
          type: string
          format: uri
          description: Presigned URL for thumbnail
        full_url:
          type: string
          format: uri
          description: Presigned URL for full image
        expires_at:
          type: string
          format: date-time
          description: URL expiration timestamp
        size_bytes:
          type: integer
          minimum: 0
          description: Image file size
        content_type:
          type: string
          default: image/jpeg
          description: MIME type

    PresignResponse:
      type: object
      required:
        - success
        - data
      properties:
        success:
          type: boolean
        data:
          type: object
          required:
            - url
            - expires_at
          properties:
            url:
              type: string
              format: uri
              description: Presigned URL
            expires_at:
              type: string
              format: date-time
              description: URL expiration timestamp
