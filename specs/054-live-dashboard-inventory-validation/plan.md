# Implementation Plan: Live Dashboard Inventory Validation

**Branch**: `054-live-dashboard-inventory-validation` | **Date**: 2026-02-17 | **Spec**: [spec.md](spec.md)
**Input**: Feature specification from `/specs/054-live-dashboard-inventory-validation/spec.md`

## Summary

Add an opt-in live E2E smoke suite that validates the inventory delta correction workflow against a real BridgeServer-backed deployment. The existing deterministic mock-based tests (Feature 053) remain the default CI path. The live suite uses env-var gating (`LIVE_E2E=1`), robust preflight checks, and deterministic SKIP when the backend is unavailable. A CI workflow job enables manual live validation with artifact capture. An operator runbook documents deploy validation steps.

## Technical Context

**Language/Version**: TypeScript ~5.9.3
**Primary Dependencies**: Playwright 1.57.0, React 19.2.0, TanStack React Query 5.x, Zod 3.x
**Storage**: N/A (tests only; backend handles all persistence)
**Testing**: Playwright 1.57.0 (E2E, live tests), existing Vitest 3.2.4 suite unchanged
**Target Platform**: Chromium-based browsers (Playwright `chromium` project)
**Project Type**: Web (single SPA)
**Performance Goals**: Live suite completes in < 2 minutes; preflight check < 5 seconds
**Constraints**: PLAYWRIGHT_WORKERS=1 for reproducibility; live tests never run without explicit opt-in
**Scale/Scope**: ~5-8 new E2E tests (live), 1 preflight utility, 1 CI job, 1 runbook document

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

### I. Hexagonal Architecture — PASS

No production code changes. All new code is in `tests/e2e/` (E2E test files) and `docs/runbooks/` (documentation). The preflight utility is a test helper, not application code.

### II. Contract-First API — PASS

Live tests validate real API responses through the UI. Zod schema validation in the application layer catches contract mismatches at runtime. No new schemas or API clients are added.

### III. Test Discipline — PASS

This feature extends test coverage to live environments. Key compliance:
- Live tests use Playwright with `PLAYWRIGHT_WORKERS=1`
- Preflight checks prevent misleading failures
- Default CI is not affected (env-var gating)
- Artifact capture enables debugging

### IV. Simplicity & YAGNI — PASS

Minimal additions: one test file, one preflight helper, one CI job, one runbook. No new abstractions or production code. The preflight utility is a plain function, not a class or framework.

### Post-Design Re-check — PASS

All Phase 1 artifacts (research.md, data-model.md, contracts/, quickstart.md) confirm no architecture violations. Key validations:
- research.md: All NEEDS CLARIFICATION resolved (R1-R7). Decisions align with existing codebase patterns.
- data-model.md: No new domain entities. Two test-infrastructure types (`PreflightResult`, `LiveTestConfig`) live in test code only.
- contracts/api-contracts.md: All consumed endpoints are pre-existing (Features 047-053). No new API surface.
- quickstart.md: All commands use existing tooling (Playwright, npm). No new build steps.

## Project Structure

### Documentation (this feature)

```text
specs/054-live-dashboard-inventory-validation/
├── spec.md              # Feature specification
├── plan.md              # This file
├── research.md          # Phase 0 research findings (R1-R7)
├── data-model.md        # Existing entity documentation + test types
├── quickstart.md        # Developer quickstart guide
├── contracts/
│   └── api-contracts.md # API endpoints consumed by live tests
├── checklists/
│   └── requirements.md  # Spec quality checklist
└── tasks.md             # Generated by /speckit.tasks
```

### Source Code (repository root)

```text
tests/e2e/
├── live-inventory-correction.spec.ts  # NEW: live E2E correction workflow
└── fixtures/
    └── live-preflight.ts              # NEW: preflight check utility

docs/runbooks/
└── live-validation-inventory.md       # NEW: operator deploy validation checklist

.github/workflows/
└── test.yml                           # EXTEND: add opt-in live-e2e job

playwright.config.ts                   # EXTEND: add live-inventory project
```

**Structure Decision**: Test-only feature — all changes are in `tests/`, `docs/`, `.github/workflows/`, and `playwright.config.ts`. Zero production code changes.

## Design Decisions

### D1: Separate File vs. Extending live-smoke.spec.ts

**Decision**: Create a new `live-inventory-correction.spec.ts` file.

**Rationale**: The existing `live-smoke.spec.ts` tests basic tab navigation against a live Pi (system, WiFi, door). Inventory correction is a fundamentally different workflow (multi-step, data-mutating). Keeping them separate follows the existing pattern of one-file-per-feature-area and allows independent execution.

### D2: Preflight as Shared Utility vs. Inline

**Decision**: Create a shared `live-preflight.ts` in `tests/e2e/fixtures/`.

**Rationale**: The preflight logic (check reachability, check inventory API, find containers with data) is ~40 lines but used by multiple tests. Extracting it avoids duplication and makes it testable. Following the existing pattern of `mock-routes.ts` in the fixtures directory.

### D3: Env Var Naming — LIVE_E2E vs. LIVE_INVENTORY

**Decision**: Use `LIVE_E2E=1` as the primary gate, with `LIVE_BASE_URL` for the target URL.

**Rationale**: `LIVE_E2E` is generic enough to gate future live test suites (cameras, config, etc.) while `LIVE_BASE_URL` replaces the existing `LIVE_PI_URL` for inventory-specific tests that target BridgeServer (which may not be on the Pi itself). The existing `LIVE_PI_URL` is preserved for backward compatibility with `live-smoke.spec.ts`.

### D4: Playwright Project vs. testMatch Filter

**Decision**: Add a `live-inventory` project in `playwright.config.ts` (similar to `live-pi`).

**Rationale**: A dedicated project allows:
- Different `baseURL` (the BridgeServer deployment, not localhost)
- Different timeouts (longer for real network)
- Conditional inclusion (only when `LIVE_E2E=1`)
- `--project=live-inventory` for targeted execution
This follows the existing `live-pi` pattern in the config.

### D5: Data Safety — Test Containers

**Decision**: Document that live tests should target a designated test container. Provide `LIVE_TEST_CONTAINER_ID` env var to specify it. If not set, the preflight picks the first available container.

**Rationale**: Live correction tests modify real data. Using a designated container prevents accidentally corrupting production inventory records. The runbook documents how to set up a test container.

### D6: CI Workflow — New Job vs. New Workflow

**Decision**: Add an opt-in `live-e2e` job to the existing `test.yml` workflow, triggered only by `workflow_dispatch` with a `live` input.

**Rationale**: Keeps all test jobs in one workflow for visibility. The job only runs when manually triggered with the `live` flag, ensuring it never runs on PR or push events. Artifact upload follows the existing pattern.

## Work Breakdown

### Phase 1: Preflight & Configuration

1. **Preflight utility** — `tests/e2e/fixtures/live-preflight.ts`
2. **Playwright config** — add `live-inventory` project

### Phase 2: Live E2E Tests

3. **Live correction workflow** — view delta, edit, submit, verify
4. **Live approve-as-is** — approve, verify audit
5. **Live connectivity smoke** — preflight + basic navigation
6. **Screenshot capture** — at each workflow step

### Phase 3: CI Integration

7. **Workflow job** — opt-in `live-e2e` job in `test.yml`
8. **Artifact upload** — screenshots, traces, report

### Phase 4: Documentation

9. **Operator runbook** — deploy validation checklist
10. **HANDOFF** — manual verification walkthrough

### Phase 5: Verification

11. **Default CI check** — verify live tests SKIP in default CI
12. **Live run check** — verify live tests pass against real backend (manual)
